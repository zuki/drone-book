# プラットフォーム固有レイヤ

このレイヤは、プラットフォームに依存しないコアと特定のプラットフォームとの間の
ギャップを埋めるものです。ここでは、ターゲット固有のintrinsicsやインライン
アセンブラを使用することができます。

プラットフォームクレートは`drone-core`ランタイムを`src/rt.rs`に実装します。
さらに、様々なユーティリティ関数をエクスポートできます。たとえば、`drone_cortexm::processor::self_reset`は、セルフリセット要求を発行する
ための一連のアセンブリ命令を実行します。

このレイヤは、DroneのスレッドAPIのバックエンドを提供します。Cortex-Mを例にとると、
このレイヤでNVIC（Nested Vectored Interrupt Controller）を利用して
Droneのスレッディングシステムが実装されています。個々のDroneスレッドが一つの
ハードウェア割り込みに対応し、NVICがスレッド間のスイッチングを担当しています。

このクレートはRustの`Future`のための`core::task::Waker`の実装を少なくとも1つ
持っていなければなりません。`drone-cortexm`は2つ実装をしており、1つは`WFE`/`SEV`
アセンブリ命令を利用した最下位のスレッド用で、もう1つは`NVIC_STIR`レジスタを利用
しています。

スタックフルなスレッドはターゲット固有性が高いため、スタックフルなDroneファイバは
このレイヤで実装されています。ターゲットがMPU（メモリ保護ユニット）を組み込んで
いる場合は、スタックオーバーフローエラーから保護するために使用する必要があります。
なぜなら、Droneコアが提供するのはメインスタックに対するゼロコスト保護だけであり、
つまり、スタックレスなファイバに対する保護しか提供していないからです。MPUがない
場合は、対応するコンストラクタ関数を`unsafe`とマークしなければなりません。

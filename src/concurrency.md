# 並行処理

並行処理モデルは、組み込みオペレーティングシステムの最も重要な側面の一つです。
組み込みマイクロコントローラのアプリケーションでは、一度に複数のイベントソースを
使用して動作する必要があります。さらに、組み込みシステムは、できるだけ頻繁に、
できるだけ長く、省電力モードでなければなりません。Droneの目的は、高い並行処理
能力を持ち、電力効率の高いアプリケーションを簡単に正しく書けるようにすることです。

まず、従来の組み込みオペレーティングシステムがどのように動作するかを見てみましょう。
それらは、各自が独自のスタックを持ち、並列に実行するタスクを作成することを可能に
します。

![Conventional RTOS](../assets/conventional-rtos.svg)

しかし、これはハードウェアが実際に設計されている方法ではありません。実際、
プロセッサは一度に一つのタスクしか実行できません。従来のオペレーティングシステムが
実際に行っていることは、タスクの切り替えを高速に行い、並列に実行しているように
**見せかけている**ことです。

![Conventional RTOS Time Sharing](../assets/conventional-rtos-slices.svg)

その並行処理モデルは、デスクトップやサーバのオペレーティングシステムには明確な
利点がありますが、組み込みリアルタイムシステムには顕著なオーバーヘッドを招きます。
また、スタックオーバーフローエラーから保護するためには、メモリ管理/保護ユニットを
内蔵したプロセッサで実行する必要がありますが、STM32F103はそのような装置を持ちません。

逆に、現代のハードウェアは、より精巧な割り込みコントローラの方向に進化しています。
たとえば、各Cortex-Mプロセッサに搭載されているNVIC（Nested Vectored
Interrupt Controller）です。NVICは、後着（late-arriving）やテールチェイン
（tail-chaining）などのスケジューリングコストを削減するためのハードウェア
最適化を数多く実装しています。Drone OSはこのような割り込みコントローラを利用して、
厳密に優先付けされた完全なプリエンプティブスケジューリングを構築します。

![Drone Concurrency](../assets/drone-single-stack.svg)

より優先度の高いタスクだけが他のタスクをプリエンプションすることができます。また、
タスクは、完了する前、あるいはイベントやリソースを待つために一時停止する前に、
スタックを完全に放棄しなければなりません。これにより、Drone OS は単一のスタックを
すべてのプログラムタスクで使用することができます。また、この単一スタックを
RAMの境界に配置することでスタックオーバーフローエラーからも保護しています。

では、Droneはどのような方法で複数のタスクのためのそのようなスタック使用を実現
しているのでしょうか。それは主として、ステートマシンに変換するRustのasync/
await構文やGenerator構文の使用によります。タスクの状態は、再開ポイント間で
保存する必要がありますが、ヒープ上に非常にコンパクトに保存されます。

オプションとして、Droneは従来のステートフルなタスクも実装しています。このような
タスクを使用し、個別のスタックを割り当てることで、既存のブロッキングコードを
Droneアプリケーションに統合することができます。この機能を安全に使用するには、
プロセッサがMMU/MPUを持っていなければなりません。そうでない場合、そのような
タスクを作成することは`unsafe`です。スタックオーバーフローからの安全性が保証
されないからです。

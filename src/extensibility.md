# Drone OSの拡張性

Droneは様々なプラットフォームに最大限に拡張できるように設計されています。Droneは、
複雑な階層構造を持つRustクレートで構成されています。主たる基盤部分は完全にプラット
フォームに非依存であり、その上にプラットフォーム固有のクレートが構築されています。

Droneのコア部分は、それが実行されるプラットフォームについてはほとんど何も仮定して
いません。1つの例外は、プラットフォームが命令レベルでアトミック操作をサポートしている
ことです。Droneは、共有のデータ構造を保護するために割り込みの無効化を決して使わない
ようにしています。

このセクションでは、Nordic Semiconductor社のnRF91マイクロコントローラシリーズを
例にとり、Droneのクレート階層をレビューします。

![Crates Hierarchy](../assets/crates-hierarchy.svg)

クレートは次のワークスペースで構成されています。

* **drone** - Droneコマンドラインユティリティ。

* **drone-core** - Droneコア機能。

* **drone-cortexm** - ARM® Cortex®-Mのサポート。

* **drone-svd** - CMSIS-SVDファイルフォーマットパーサ。

* **drone-nrf-map** - Nordic Semiconductor社製nRFxのマッピング。

* **drone-nrf91-dso** - Nordic Semiconductor社製nRFx91用のDroneシリアル出力実装。

## 新しいチップのサポート

まだサポートしていないチップをドローンがサポートするようにするためには、まずその
プラットフォームを決定する必要があります。まだプラットフォームがサポートされていない
場合（たとえば、RISC-V）は、`drone-riscv`クレートの作成から始めます。すでに
プラットフォームがサポートされている（たとえば、Cortex-M）が、まだプラットフォームの
バージョンがサポートされていない場合（たとえば、Cortex-M23）は、既存の
`drone-cortexm`クレートを拡張します。

プラットフォームがサポートされたら、レジスタと割り込みマッピングを追加する必要が
あります。そのチップシリーズ用のクレートが既に存在するか否かを調べる必要があります。
そのようなクレートがない場合（たとえば、Texas Instruments SimpleLink™）は
新しく`drone-tisl-map`を作成する必要があります。たとえば、STM32WB55をサポート
する必要がある場合は、既存の`drone-stm32-map`クレートを拡張する必要があります。

チップにハードウェアロギング機能（たとえば、SWO）がない場合は、たとえば、汎用の
UAETペリフェラルを使ってソフトウェアでDSO（Drone Serial Output）プロトコルを
実装したクレートを作成する必要があります。

最後に、`drone`CLIユーティリティにチップのことを知ってもらう必要があります。
チップには少なくとも1つのデバッガと少なくとも一つのロガーのオプションがなければ
なりません。これについては次のセクションで説明します。

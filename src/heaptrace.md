# ヒープトレース

Drone OSは、特定のアプリケーションの用途に合わせて、組み込みのアロケータを微調整
するためのツールを提供しています。

新規作成されたDroneプロジェクトには`heaptrace`機能が事前定義されています。この
機能を有効にすると、アロケータはアロケータ操作をログポート#31に記録します。これらの
ログを捕捉するためには、まず、この機能を有効にしたバージョンのアプリケーション
ファームウェアをターゲットデバイスに書き込む必要があります。

```shell
$ just features=heaptrace flash
```

次に、このデータを捕捉するための特別なレシピを実行します。

```shell
$ just heaptrace
```

このレシピは`just log`と似ていますが、加えてポート#31の出力を取得し、
`heaptrace`という名前のファイルに書き込むという違いがあります。十分なデータが
収集されたと思ったら、Ctrl-Cで停止してください。

プロジェクトのルートに収集されたデータを含む空でない`heaptrace`ファイルが
ある場合、次のコマンドを使ってヒープの使用を分析できます。

```shell
$ drone heap
```

`just heaptrace`実行中の全割り当ての統計が出力されます。

```text
 Block Size | Max Load | Total Allocations
------------+----------+-------------------
          1 |        1 |                 1
         12 |        3 |                 7
         28 |        1 |                 2
         32 |        1 |                 1
        128 |        1 |                 2

Maximum memory usage: 225 / 2.20%
```

The data in the `heaptrace`ファイルのデータは最適なメモリプールレイアウトの
生成にも使用することができます。

```shell
$ drone heap generate --pools 5
```

ここでは`5`はプールの最大数です。プール数が少ないほど、フラグメンテーションは
多くなりますが、割り当てが高速になります。次のような結果が得られるはずです。

```text
=============================== SUGGESTED LAYOUT ===============================
[heap]
size = "10K"
pools = [
    { block = "4", capacity = 201 },
    { block = "12", capacity = 222 },
    { block = "28", capacity = 115 },
    { block = "32", capacity = 83 },
    { block = "128", capacity = 7 },
]
# Fragmentation: 0 / 0.00%
```

これは`Drone.toml`に置くのにふさわしい`[heap]`セクションを生成します。
